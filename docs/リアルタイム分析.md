# おむすびコロリン_アプリ仕様書

## アプリ名称
**Sherpath**
> 意味：Sherpathは「Sherpa」と「Path」の合成語で、「Sherpa」は登山ガイドを意味し、「Path」は道筋や経路を意味する。このアプリは、利用対象者である事業部門のメンバーが、どんな論点を、どこに相談すべきかの道筋を案内し、適切な相談先に繋げることを目的としており、商品のリリースという高い山を登頂まで伴奏する心強い相棒となることを想定して、Sherpathという名称を採用した。

## 背景・現状の課題
- 酒類の製造販売という規制産業ゆえに、多種多様な法令・ルールへ適合する必要がある。
- 新たな施策を行うにあたって、企画段階から法令やルールへの適合性やリスク検討を行う必要がある。
- リスク検討あたっては、関係する部署との連携が必須となる。
- 関係する部署との連携は行えているが、コミュニケーションコストが高くなっている。

## 提供価値
- 事業部門のメンバーが、検討している施策やサービスの中に、どんな論点があり、その論点を誰に相談すべきかの整理を行い、アプリからTeamsに連携する仕組みで、論点整理から実際の相談までをワンストップでできる体験を提供する。

## メインターゲット
- 業務歴1〜3年目の商品企画担当者（新商品プロジェクトの中心推進者）
- 特徴：商品構想〜社内連携〜発売実現までのプロジェクトリーダー。営業・中身開発・製造・品質保証・法務・購買など関係者を巻き込んで進行。初期段階の「どんな商品をつくるか」「どんな売り方が可能か」において、法令や業界ルールの壁が大きく、社内調整が多い。
- 課題：何を調べればよいか分からず、相談の仕方も不明。関係者が多く、対応が重複する。
- ニーズ：この相談は、どこに・誰に相談すべきなのかを整理して、担当者につないで欲しい。社内で過去に似た事例があるかどうかも知りたい（「過去どうしたか」への依存度が高い

## アプリのコンセプト
**「答えるAI」から「導くAI」へ**

## アプリの機能概要
- 自分の相談内容をダッシュボードで管理・閲覧できる
- 施策内容を入力して論点等を整理する機能、企画書や計画書など資料をアップロードして論点等を整理する機能の2機能がある
    - 論点等の整理は、生成AI（RAG）を用いて適切な論点整理と相談先の提案を行う
- ログイン機能を用いて、セキュアなアプリ利用を実現する
- 自分の論点整理内容がデータベース（MySQLおよびベクトルデータベース）に蓄積されていく
- 他の人の論点整理を検索して確認できる
- 様々な人の論点整理内容がデータベースに蓄積されることで、AIによる回答精度が向上する

## 技術スタック
### フロントエンド
- Next.js
- Tailwind CSS
- Shadcn UI
- React
- TypeScript

### バックエンド
- Python
- FastAPI
- Langchain
- Langgraph

### データベース
- MySQL
- MongoDB

### 生成AI
- OpenAI

## アプリの機能詳細
- **ログイン機能**
> 実装済みのため作成不要
    - アプリを開いた最初のページに表示される
    - ログインはメールアドレスとパスワード（8文字以上）で行う
    - 認証処理をJWT（JSON Web Token）を用いて行う
    - ログイン後は、メニュー画面に遷移する
    - ログインしていない場合は、ログイン画面に遷移する
    - パスワードはハッシュ化して保存する（bcryptを用いる）
    - 操作ログが操作ログデータベースに蓄積される
    - ユーザーマスタにはid、email、password_hash、role、is_active、created_at	DATETIME、updated_atが保存される

- **相談したい施策内容の入力機能**
    - ログイン後に、相談したい施策内容の入力画面が表示される。
    - 入力欄に相談したい施策内容を入力する。
    - 入力の他、アップロードした企画書・計画書などの資料をもとに、論点・質問事項の整理と相談先の分析を行う。
        - 対象ファイル形式：Word（.docx）、Excel（.xlsx）のみ（それ以外は対象外）
        - 取得方式：Word/Excelはテキスト抽出を行い、リアルタイム分析に合算して利用する（OCRは使用しない）

    - **リアルタイム入力分析機能**
        - 入力内容に対して、論点や質問事項を整理するために情報が不足しているのか、具体的になっているのかをリアルタイムで判定し、不足している情報を追加で入力するように促す。
        - **判定方式：ハイブリッド分析**
            - **ルールベース判定**：キーワードの有無と文章構造を即座に分析（レスポンス時間：即時）
                - 商品・サービス内容の記載有無
                - ターゲット顧客の明確性
                - 予算・コスト情報の記載
                - スケジュール・時期の記載  
                - 目的・目標の明確性
            - **AI判定**：OpenAI APIを活用した詳細分析（レスポンス時間：800ms後、デバウンス処理）
                - 文章の論理構造分析
                - 情報の具体性評価
                - 不足情報の特定と提案生成
        - **5段階進行バー表示（RealtimeProgressBar）**
            - **1〜2段階（不足・グレー）**：基本的な情報が大幅に不足している状態
            - **3段階（中程度・イエロー）**：ある程度の情報はあるが、詳細化が必要な状態
            - **4段階（高程度・オレンジ）**：相談可能レベルに近いが、若干の追記が望ましい状態
            - **5段階（充足・グリーン）**：論点整理に十分な情報が揃っている状態
        - **リアルタイム提案機能**
            - 不足している情報カテゴリをバッジ形式で表示
            - 具体的な追加推奨項目を動的に提示
            - 例：「ターゲット層の詳細」「予算規模」「実施時期」等
        - **パフォーマンス最適化**
            - デバウンス処理（800ms）でAPI呼び出し頻度を制御
            - キャッシュ機能により同一入力の高速レスポンス
            - 段階的判定：即座のルールベース → 詳細なAI分析の順で実行
        - **APIエンドポイント**
            - /api/analyze
            - POSTメソッド
            - リクエストボディ：{ "text": "相談内容" }
            - レスポンスボディ：{ "completeness": 0.8, "suggestions": ["論点1", "論点2"], "confidence": 0.9 }
    - 入力完了したら、「相談する」ボタンをクリックすることで、バックエンドで連携する生成AI・RAGによって、論点・質問事項の整理と相談先の分析を行う。

- **論点・質問事項と相談先の表示**
    - 入力されたテキスト情報又は/及びアップロードされた企画書・計画書などの資料をもとに、生成AIによって論点・質問事項の整理と相談先の分析を行う。
    - 分析には、RAGを用いて、法令や過去の相談事例を参照して、論点・質問事項の整理と相談先の分析を行う。
    - 分析結果のレスポンスは、*相談者が入力した相談内容*, *整理した論点や相談先に聞く質問内容*, *相談先の担当者*の3つの項目に分けて表示する。
    - 分析結果は、データベースに蓄積される。
    - データベースには、相談者が入力した相談内容、整理した論点や相談先に聞く質問内容、相談先の担当者の情報が保存される。
    - **APIエンドポイント**
        - /api/analytics
        - POSTメソッド
        - リクエストボディ：{ "text": "相談内容" }
        - レスポンスボディ：   {"summary": "相談内容の要約", "questions": ["質問事項1","質問事項2", "質問事項3"],"consultants": [ { "name": "相談先1","department": "部署名","expertise": "専門分野"},{"name": "相談先2","department": "部署名", "expertise": "専門分野"}],"analysis_metadata": {"confidence": 0.85,"generated_at": "2024-01-01T12:00:00Z"}}

- **Teamsとの連携による相談先への相談**
    - 論点・質問事項と相談先が表示された後、「相談先に送信」ボタンをクリックすることで、Teamsとの連携による相談先への相談を行う。
    - ボタンクリック後にTeamsが立ち上がり、相談相手にメンション付きで相談内容、整理した論点や質問内容が指定したチャネルに投稿される。
    - 相談先へのメッセージ送信は、TeamsのAPIを用いて行う。
    - **APIエンドポイント**
        - /api/send_message
        - POSTメソッド
        - リクエストボディ：{ "text": "相談内容", "questions": ["質問事項1","質問事項2", "質問事項3"],"consultants": [ { "name": "相談先1","department": "部署名","expertise": "専門分野"},{"name": "相談先2","department": "部署名", "expertise": "専門分野"}]}
        - レスポンスボディ：{ "status": "success" }

- **自分が実施した論点整理内容の履歴確認**
    - 自分が実施した論点整理の履歴を確認できる。
    - 履歴は検索もでき、検索は、相談先の名前や部署名、専門分野などで行う。
    - 検索結果は、相談先の名前、部署名、論点整理内容を表示する。

- **他の人の論点整理内容の検索**
    - 他の人の論点整理内容を検索できる。
    - 検索は、相談先の名前や部署名、専門分野などで行う。
    - 検索結果は、相談先の名前、部署名、論点整理内容を表示する。

## ディレクトリ構成
### フロントエンド

フロントエンドのディレクトリ構成（[新規]は今回追加想定）

```text
src/
  app/
    layout.tsx
    page.tsx
    api/
      login/
        route.ts
      logout/
        route.ts
      user/
        me/
          route.ts
    consult/                 [新規]
      new/                   [新規]
        page.tsx             [新規]
  components/
    BeerLoadingAnimation.tsx
    FileUploadSystem.tsx
    LoginForm.tsx
    ConsultTextArea.tsx      [新規]
    RealtimeProgressBar.tsx  [新規]
    SuggestionBadges.tsx     [新規]
    SuggestionList.tsx       [新規]
  contexts/
    AuthContext.tsx
  hooks/                     [新規]
    useRealtimeAnalysis.ts   [新規]
  lib/
    database.ts
    jwt.ts
    password.ts
    validation.ts
```

- ページ/ルーティング（App Router）
    - `src/app/consult/new/page.tsx`：相談したい施策内容の入力画面（ログイン後の遷移先）
    - `src/app/layout.tsx`：グローバルヘッダー/ナビ（Figmaの`Header`インスタンスに相当）
    - 認証リダイレクト：未ログイン時は`/`（ログイン）へ遷移（`contexts/AuthContext.tsx`を利用）

- 主要コンポーネント（Shadcn UI + Tailwind）
    - `ConsultInputPage`（ページコンテナ）：画面全体のレイアウトを構成
    - `ConsultTextArea`：施策内容のテキスト入力（文字数/行数カウンタ、placeholder例）
    - `FileUploadSystem`：資料アップロード（既存を再利用、OCRはバックエンド経由）
    - `RealtimeProgressBar`：5段階進行バー（1〜2段階（不足）=グレー / 3段階（中程度）=イエロー / 4段階（高程度）=オレンジ / 5段階(充足)=緑）
    - `SuggestionBadges`：不足カテゴリのバッジ表示
    - `SuggestionList`：具体的な追加推奨項目のリスト表示
    - `BeerLoadingAnimation`：AI判定中インジケータ（既存アニメーションを利用）
    - `SubmitButton`：「相談する」ボタン
    - `Header`/`Navi`：`app/layout.tsx`で提供（Figmaのヘッダー構成を反映）

- フック/ユーティリティ
    - `useRealtimeAnalysis`：リアルタイム分析用のカスタムフック
        - ルールベース即時判定 → 800msデバウンス後にAI判定（`/api/analyze`）
        - 入力テキストをキーにしたメモリキャッシュ（`Map<string, AnalyzeResult>`）
        - ファイル連携：アップロードされたWord/Excelから抽出した`docText`を入力テキストと結合して評価
        - 戻り値：`{ completeness: 1|2|3|4|5, suggestions: string[], confidence?: number, loading: boolean, error?: string }`

- ファイルアップロード（リアルタイム分析対応）
    - UI：`FileUploadSystem`（参照: [アップロードUI（node 480-4112）](https://www.figma.com/design/lKKbpnSOWd4bAk8C2YY0BW/Free-space?node-id=480-4112)）
    - 受付拡張子：`.docx`, `.xlsx`（対象外は即時バリデーションで拒否し、エラーメッセージ表示）
    - フロー：
        1) ユーザーがファイル選択 → 拡張子バリデーション
        2) 非同期で`POST /api/extract_text`にアップロード → 抽出結果`extractedText`を受領
        3) `useRealtimeAnalysis`が`text + extractedText`を入力として再評価（デバウンスは入力と共有）
    - 表示：抽出中はローディング、完了後に`SuggestionBadges`/`SuggestionList`/`RealtimeProgressBar`を更新
    - `useAuth`：`contexts/AuthContext.tsx`経由でユーザー状態を取得

- UI構成（Figma準拠）
    - ベース幅：`1440`、主コンテナ幅：約`828px`、中央寄せ、縦方向`gap: 40px`、全体`gap: 80px`
    - ヘッダー：Figmaの`Header`インスタンス（ロゴ/ナビ/ユーザーメニュー想定）
    - タイトル：テキスト「酒税について、何が知りたいですか？」（中央揃え、太字・24px相当）
    - 本文構成：
        - 入力領域：`ConsultTextArea` + `FileUploadSystem`
        - 分析領域：`RealtimeProgressBar`、`SuggestionBadges`、`SuggestionList`
    - 余白/配色：TailwindでFigmaの`gap: 16px/40px/80px`と背景トーンを再現

- 振る舞い（ハイブリッド分析のUI反映）
    - 入力変更時：
        - 即時にルールベース判定を実行し、進行バー/バッジを更新
        - 800ms入力が途切れたらAI判定API（`/api/analyze`）を呼び、提案リスト等を上書き
    - 読み込み：`BeerLoadingAnimation`を表示
    - エラー：トースト/インラインで通知（再試行ボタン）
    - 相談実行：`SubmitButton`で確定。次画面（論点・相談先表示）へ遷移

- 状態/データフロー
    - ローカル：入力テキスト、アップロード済みファイル、進行度（0/1/2）、不足カテゴリ、提案リスト
    - 非同期：`loading`/`error`/`lastUpdated`、AI判定レスポンス（`completeness, suggestions, confidence`）
    - キャッシュ：同一テキストのAI判定結果を`Map`で保持し即時反映

- パフォーマンス最適化
    - デバウンス：800ms（テキストエリア）
    - レンダリング：`useMemo`/`useCallback`で重い計算のメモ化、コンポーネント分割
    - 遅延読み込み：分析系コンポーネントは必要時にロード（必要に応じて）

- アクセシビリティ/UX
    - キーボード操作配慮（Tab移動/Cmd+Enter送信は将来拡張）
    - ARIA：進行バー/バッジ/リストに役割とラベルを付与
    - 入力補助：placeholder、例示文、最小入力ガイダンス

- エンドポイント連携
    - 事前抽出：`POST /api/extract_text`
        - 送信：`multipart/form-data`（フィールド名`files[]`、`.docx/.xlsx`のみ）
        - 応答：`{ extractedText: string, files: [{ name: string, bytes: number }] }`
    - AI判定：`POST /api/analyze`
        - ボディ：`{ text: string, docText?: string }`（`docText`に抽出テキストを渡す）
        - レスポンス：`{ completeness: number, suggestions: string[], confidence?: number }`
    - 相談実行：`/api/analytics`は次画面で使用（本画面では入力内容の整形のみ）

- 想定ファイル構成（例）
    - `src/app/consult/new/page.tsx`
    - `src/components/ConsultTextArea.tsx`
    - `src/components/RealtimeProgressBar.tsx`
    - `src/components/SuggestionBadges.tsx`
    - `src/components/SuggestionList.tsx`
    - `src/hooks/useRealtimeAnalysis.ts`
    - 既存：`src/components/FileUploadSystem.tsx`、`src/components/BeerLoadingAnimation.tsx`、`src/contexts/AuthContext.tsx`

#### RealtimeProgressBar / SuggestionBadges / SuggestionList 状態別表示仕様

- 色トークン（Figma準拠）
    - 不足：グレー `#959595`（参考: 情報不足画面のMessage塗り）
    - 中程度：イエロー `#C6AA0E`（参考: 3段階画面のMessage塗り）
    - 高程度：オレンジ `#FF753E`（参考: 4段階画面のMessage塗り）
    - 充足：グリーン `#16C47F`（参考: 5段階画面のMessage塗り）

- 情報不足（1〜2段階）
    - RealtimeProgressBar：5セグメント中1〜2をグレーで充填。
    - SuggestionBadges：必須カテゴリを強調表示（例：商品/サービス、ターゲット顧客、スケジュール、目的・目標）。
    - SuggestionList：不足の根因に直結する基本項目を優先表示。UIメッセージ例：
        - 「内容なさすぎる・・」「これは情報不足やね」「情報が足りない...!」
      参考デザイン: [情報不足（node 480-4055）](https://www.figma.com/design/lKKbpnSOWd4bAk8C2YY0BW/Free-space?node-id=480-4055)

- 3段階（中程度）
    - RealtimeProgressBar：5セグメント中3をイエローで充填。
    - SuggestionBadges：不足カテゴリのみを表示。優先度の高い順に並べる。
    - SuggestionList：具体化のための追記ポイントを提示。UIメッセージ例：
        - 「もう少し教えて？」「もう少し...!」
      参考デザイン: [3段階（node 480-4258）](https://www.figma.com/design/lKKbpnSOWd4bAk8C2YY0BW/Free-space?node-id=480-4258)

- 4段階（高程度）
    - RealtimeProgressBar：5セグメント中4をオレンジで充填。
    - SuggestionBadges：任意（Nice to have）項目のみ表示。
    - SuggestionList：軽微な追記・明確化の提案に限定。UIメッセージ例：
        - 「まぁまぁいいやん」
      参考デザイン: [4段階（node 480-4333）](https://www.figma.com/design/lKKbpnSOWd4bAk8C2YY0BW/Free-space?node-id=480-4333)

- 5段階（充足）
    - RealtimeProgressBar：5セグメント全てをグリーンで充填。
    - SuggestionBadges：原則非表示。必要に応じ「準備完了」等の完了バッジを1つ表示。
    - SuggestionList：表示しない（または折りたたみ表示）。UIメッセージ例：
        - 「十分回答できそう！」
      参考デザイン: [5段階（node 480-4351）](https://www.figma.com/design/lKKbpnSOWd4bAk8C2YY0BW/Free-space?node-id=480-4351)

備考：実際のテキスト提示はAIの`suggestions`結果を優先し、上記メッセージはトーン/ステートの例示として利用する。

### バックエンド

#### 概要
- 技術: FastAPI（Python）、OpenAI API、（任意）Redisキャッシュ
- 方針: ルールベース分析 + AI分析のハイブリッド構成。フロントのデバウンス（800ms）を前提に、毎リクエストで統一インターフェースを提供。

#### エンドポイント
- POST `/api/extract_text`
  - 受領: `multipart/form-data`（フィールド名`files[]`、拡張子`.docx`/`.xlsx`のみ）
  - 返却: `{ extractedText: string, files: [{ name: string, bytes: number }] }`
  - 役割: Word/Excelからテキスト抽出。OCRは不使用。
  - 制約: 拡張子バリデーション、サイズ上限、同時アップロード数（詳細は下記「制限」）。

- POST `/api/analyze`
  - 受領: `{ text: string, docText?: string }`
  - 返却: `{ completeness: 1|2|3|4|5, suggestions: string[], confidence?: number }`
  - 役割: ルールベース即時判定 + OpenAIによる詳細提案の統合応答。
  - キャッシュ: 正規化した`text + docText`をキーにキャッシュ（下記参照）。

（参考）他機能で利用: `/api/analytics`（論点/相談先分析）、`/api/send_message`（Teams連携）

#### 分析フロー（/api/analyze）
1) 入力統合・前処理
   - `normalizedText = trim(text + "\n\n" + (docText || ""))`
   - 長文対策: 先頭N文字（例: 4000–6000文字）へクリップ、正規化（全角/半角/改行整形）

2) ルールベース判定（即時）
   - チェック項目（6分類）
     - 商品・サービス内容 / 対象顧客・ターゲット / スケジュール・時期 / 目的・目標 / 市場・競合分析（任意）
   - 各分類のキーワード/構文（例: 金額/日時/対象語/目的語）を抽出し、充足数`covered`を算定
   - 基礎提案: 欠落分類に対する不足提案を生成

3) AI判定（デバウンス後にフロントから呼出）
   - OpenAIへ`normalizedText`とルールベース結果をプロンプト化し、
     - 具体化提案の充実 / 論理構造の確認 / 重複削減 / 表現の明確化 を生成
   - `suggestions`を統合（重複排除・優先度付け）

4) スコアリング → 5段階化
   - 完成度スコア`s`（0.0–1.0）を内部計算（例: `s = (covered / 5) * α + aiConfidence * (1-α)`、`α`は0.6目安）
   - 段階マッピング（前提: フロント表示は5段階）
     - 0.00–0.19 → 1（不足）
     - 0.20–0.39 → 2（不足）
     - 0.40–0.59 → 3（中程度）
     - 0.60–0.79 → 4（高程度）
     - 0.80–1.00 → 5（充足）
   - `confidence`はAI応答の自己評価やプロンプト制約違反の有無を考慮して算出（0–1）

#### キャッシュ方針
- キー: `sha256(normalizedText)`
- 値: `AnalyzeResponse`（`completeness`/`suggestions`/`confidence`）
- TTL: 1時間（要件に応じて可変）。ヒット時は即応答し、サーバ負荷とコストを削減。

#### エラー/制限/保護
- 制限
  - `/api/extract_text`: 1ファイル最大10MB、同時最大3ファイル、拡張子は`.docx/.xlsx`のみ
  - `/api/analyze`: `text+docText`合計最大64KB（超過時はクリップ）
- 応答コード
  - 400: バリデーション不備（拡張子/必須項目）
  - 413: ペイロード過大
  - 429: レートリミット超過（IP/ユーザー単位）
  - 500: 予期せぬエラー
- 保護
  - 認証: JWT検証（ログイン済みのみ許可）
  - ログ: 監査用にリクエスト/応答メタデータを記録（本文はPII対策でマスキング/要約）

#### 型（Pydantic想定）
```json
// AnalyzeRequest
{ "text": "string", "docText": "string?" }

// AnalyzeResponse
{ "completeness": 1, "suggestions": ["string"], "confidence": 0.85 }

// ExtractTextResponse
{ "extractedText": "string", "files": [{ "name": "string", "bytes": 12345 }] }
```

#### 実装構成（例）
- ルーター: `api/analyze.py`, `api/extract_text.py`, `api/health.py`
- サービス: `services/analysis_service.py`（ルール+AI統合）, `services/cache_service.py`
- ユーティリティ: `utils/rule_analyzer.py`（正規表現/キーワード辞書）, `utils/text_normalizer.py`
- モデル: `models/schemas.py`（Pydanticモデル）


## 更新履歴
- 2025/08/01 初版作成
- 2025/08/02 文言を一部修正
- 2025/08/09 ディレクトリ構成を更新